<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:bal="http://wixtoolset.org/schemas/v4/wxs/bal">
  <Bundle Name="Local LLM Workbench Setup"
          Manufacturer="MTheUnexpected"
          Version="0.1.2.0"
          UpgradeCode="5D54A200-90F4-4CF8-BD1C-95D0046A282C">

    <Log Prefix="LocalLLMWorkbench-Setup" Extension="log" />

    <Variable Name="InstallLogHint" Type="string" Value="%APPDATA%\\LocalLLMWorkbench\\installer-logs\\install.log" />
    <Variable Name="InstallFolder" Type="string" Value="[ProgramFiles64Folder]Local LLM Workbench" bal:Overridable="yes" />

    <BootstrapperApplication>
      <bal:WixStandardBootstrapperApplication
        Theme="rtfLargeLicense"
        LicenseFile="assets\License.rtf"
        SuppressOptionsUI="no"
        ShowVersion="yes" />
    </BootstrapperApplication>

    <Chain>
      <ExePackage Id="DockerPreflight"
                  DisplayName="Checking Docker Desktop prerequisites"
                  SourceFile="..\payload\run-preflight.cmd"
                  Compressed="yes"
                  PerMachine="yes"
                  InstallCommand=""
                  RepairCommand=""
                  Vital="yes">
        <Payload SourceFile="..\scripts\common.ps1" Name="scripts\common.ps1" />
        <Payload SourceFile="..\scripts\preflight.ps1" Name="scripts\preflight.ps1" />
      </ExePackage>

      <ExePackage Id="InstallerUxProgress"
                  DisplayName="Preparing installation steps and file list"
                  SourceFile="..\payload\run-ux-progress.cmd"
                  Compressed="yes"
                  PerMachine="yes"
                  InstallCommand=""
                  RepairCommand=""
                  Vital="yes">
        <Payload SourceFile="..\scripts\common.ps1" Name="scripts\common.ps1" />
        <Payload SourceFile="..\scripts\install-ux-progress.ps1" Name="scripts\install-ux-progress.ps1" />
      </ExePackage>

      <ExePackage Id="VCRedist"
                  DisplayName="Installing Microsoft Visual C++ Redistributable (x64)"
                  DownloadUrl="https://aka.ms/vs/17/release/vc_redist.x64.exe"
                  PerMachine="yes"
                  Compressed="no"
                  InstallCommand="/install /passive /norestart"
                  RepairCommand="/repair /passive /norestart"
                  Vital="yes" />

      <MsiPackage Id="WorkbenchMsi"
                  DisplayName="Installing Local LLM Workbench application files"
                  SourceFile="..\..\app\release\Local LLM Workbench 0.1.0.msi"
                  DisplayInternalUI="yes"
                  Visible="yes"
                  Vital="yes">
        <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
      </MsiPackage>

      <ExePackage Id="StackValidation"
                  DisplayName="Running Test Stack and container validation"
                  SourceFile="..\payload\run-postinstall-stack.cmd"
                  Compressed="yes"
                  PerMachine="yes"
                  InstallCommand=""
                  RepairCommand=""
                  Vital="yes">
        <Payload SourceFile="..\scripts\common.ps1" Name="scripts\common.ps1" />
        <Payload SourceFile="..\scripts\postinstall-stack.ps1" Name="scripts\postinstall-stack.ps1" />
      </ExePackage>
    </Chain>
  </Bundle>
</Wix>
